<html>
<head>
    <meta charset="UTF-8">
    <title>{ title }</title>
    <script src="https://cdn.staticfile.org/video.js/8.5.3/video.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/video.js/8.5.3/video-js.min.css" />
    <style>
        body {
            width: 90vw;
            height: 90vh;
        }
        #myVideo {
            width: 80%;
            height: 90%;
        }
        /* 超级无敌好看的按钮样式 */
        button {
          display: inline-block;
          font-weight: bold;
          text-align: center;
          text-decoration: none;
          user-select: none;
          background-color: #4CAF50;
          color: white;
          padding: 15px 15px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: background-color 0.3s, transform 0.3s;
          margin: 10px;
        }

        button:hover {
          background-color: #45a049;
          transform: scale(1.1);
        }

        button:active {
          background-color: #3e8e41;
          transform: scale(0.9);
        }
        .header {
            display: flex;
            justify-content: space-between;
        }
        .main {
            {#display: flex;#}
            {#justify-content: space-between;#}
        }
    </style>
</head>
<body>
<div class="header">
    <button onclick="copyLink()">分享一起看链接</button>
    <h3>主控端（负责控制播放器的状态，被控端会同步您的进度）</h3>
    <h2 id="count" style="text-align: center">当前在线人数：0</h2>
</div>
{#<button onclick="syncProgress()">同步</button>#}
<!-- 假设你的Django路由是/streaming/ -->
<div class="main">
    <video id="myVideo" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto">
        <source id="source" src="{{ m3u8Url }}" type="application/x-mpegURL">
    </video>
</div>
<script>
// 复制链接
function copyLink() {
    // 获取到域名根
    var Url = location.protocol + "//" + location.host;
    var Url2 = Url + '/streaming/' + token;
    var oInput = document.createElement('input');
    oInput.value = Url2;
    document.body.appendChild(oInput);
    oInput.select(); // 选择对象
    document.execCommand("Copy"); // 执行浏览器复制命令
    oInput.className = 'oInput';
    oInput.style.display = 'none';
    alert('复制成功');
}

// videojs 简单使用
hander = videojs('myVideo', {
    bigPlayButton: true,
    textTrackDisplay: false,
    posterImage: false,
    errorDisplay: false
})

// 页面加载完成后自动播放
hander.ready(function () {
    var player = this;
    
    player.play();
    
    player.on('ended', function () {
        player.play();
    });
    
    // 同步一次进度

    // 定时更新进度条
    setInterval(() => {
          sendProgressToBackend(videoPlayer.currentTime(), videoPlayer.duration(), videoPlayer.paused() ? 'pause' : 'play');
    }, 3 * 1000)
});

// 按键绑定
document.onkeydown = function (event) {
    var e = event || window.event || arguments.callee.caller.arguments[0];
    // 按 空格键
    if (e && e.keyCode == 32) { 
        if (hander.paused()) {
            hander.play();
        } else {
            hander.pause();
        }
    } else if (e && e.keyCode == 37) { // 按 左键
        hander.currentTime(hander.currentTime() - 5);
    } else if (e && e.keyCode == 39) { // 按 右键
        hander.currentTime(hander.currentTime() + 5);
    } else if (e && e.keyCode == 38) { // 按 上键
        hander.volume(hander.volume() + 0.1);
    } else if (e && e.keyCode == 40) { // 按 下键
        hander.volume(hander.volume() - 0.1);
    } 
    
};


const videoPlayer = hander;

var token = "{{ token }}";

var ws = new WebSocket("ws://" + window.location.host + "/room");

// 连接成功事件
ws.addEventListener("open", function (event) {
    // 连接成功后发送token
    ws.send("setroom--" + token);
    ws.send("getprogress--" + token)
});

const count = document.getElementById('count');

// 收到消息事件
ws.addEventListener("message", function (event) {
    // 收到消息后解析消息, 并更新进度条
    const data = JSON.parse(event.data);
    count.innerText = '当前在线人数：' + data.count;
    if (data.msg === '{"msg": "ok"}') return;

    // 没有播放器状态信息
    if (!data.hasOwnProperty('status')) return;

    if (data.status === 'play') {
        hander.currentTime(data.currentTime);
        hander.play();
    } else {
        hander.currentTime(data.currentTime);
        hander.pause();
    }

});

// 手动调节进度条时
hander.on('seeking', function () {
    sendProgressToBackend(videoPlayer.currentTime(), videoPlayer.duration(), videoPlayer.paused() ? 'pause' : 'play');
});

// 播放状态改变时
hander.on('play', function () {
    sendProgressToBackend(videoPlayer.currentTime(), videoPlayer.duration(), videoPlayer.paused() ? 'pause' : 'play');
});
hander.on('pause', function () {
    sendProgressToBackend(videoPlayer.currentTime(), videoPlayer.duration(), videoPlayer.paused() ? 'pause' : 'play');
});

function sendProgressToBackend(currentTime, duration, status) {
    // websocket 通知其他用户
    ws.send("setprogress--" + token + "--" + JSON.stringify({ currentTime: currentTime, duration: duration, status: status, timestamp: Date.now()/1000 }));
}
</script>
</body>
</html>

